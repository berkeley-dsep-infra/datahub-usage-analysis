name: Test Jupyter Notebooks

on:
  workflow_dispatch: 
  push:
    branches:
      - main
    paths:
      - '**.ipynb'

jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: us-central1-docker.pkg.dev/ucb-datahub-2018/user-images/data100-user-image:4497642d
      options: --user root
      credentials:
        username: _json_key
        password: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get changed files
      id: changed-files
      run: |
        echo GITHUB_WORKSPACE: $GITHUB_WORKSPACE
        ls -a ${GITHUB_WORKSPACE}

        REPO_FULL_NAME="${{ github.repository }}"
        echo REPO_FULL_NAME="${REPO_FULL_NAME}"
        REPO_NAME="${REPO_FULL_NAME#*/}"
        echo REPO_NAME="${REPO_NAME}"
        WORKSPACE_DIR="/__w/${REPO_NAME}/${REPO_NAME}"
        echo "WORKSPACE_DIR=${WORKSPACE_DIR}" >> $GITHUB_ENV

        ls -a ${WORKSPACE_DIR}
        cd ${WORKSPACE_DIR}

        CHANGED_FILES=$(git diff --name-only HEAD^)
        echo "changed_files=${CHANGED_FILES}" >> $GITHUB_OUTPUT

    - name: Add debugging
      env:
        CHANGED_FILES: ${{ steps.changed-files.outputs.changed_files }}
      run: |
        echo "pwd: " `pwd`
        echo "changed_files: $CHANGED_FILES"
        echo ============================
        echo "ls"
        ls
        echo ============================
        echo "ls ${WORKSPACE_DIR}"
        ls ${WORKSPACE_DIR}
        echo ============================
        echo "ls /__w"
        ls /__w
        echo ============================
        shell: bash

    #- name: Get changed files
    #  id: changed-files
    #  uses: tj-actions/changed-files@v44

    - name: Execute changed notebooks
      env:
        CHANGED_FILES: ${{ steps.changed-files.outputs.changed_files }}
      run: |
        for file in ${CHANGED_FILES}; do
          if [ -f "${file}" ]; then
            if [[ $file == *.ipynb ]]; then
              echo "Converting: '${file}'"
              jupyter nbconvert --to notebook --execute --inplace "$file"
            fi
          else
            echo "No such file: '${file}'"
          fi
        done  

    - name: Check for errors
      run: |
        cd $WORKSPACE_DIR
        for file in $(find . -type f -name "*.ipynb"); do
          if grep -q "Execution failed" "$file"; then
            echo "Notebook execution failed: $file"
            exit 1
          fi
        done
        shell: bash
